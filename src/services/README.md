# 🔧 Папка `services/` — Бизнес-логика и хранение данных

Эта папка содержит **сервисы** — модули, которые выполняют главную работу программы: хранят пароли, шифруют их и управляют данными.

---

## 🤔 Что такое "сервис"?

**Сервис** — это класс (или объект), который отвечает за конкретную задачу в программе.

Аналогия из жизни: представьте банк. В банке есть разные отделы:
- **Отдел кредитов** — выдаёт кредиты
- **Отдел сейфов** — хранит ценности
- **Отдел обмена валют** — меняет деньги

В программе сервисы работают так же — каждый отвечает за свою задачу.

---

## 📄 Файлы в этой папке

| Файл | Назначение |
|------|------------|
| `password-service.ts` | Интерфейс — "контракт" на то, что должен уметь сервис |
| `encrypted-password-service.ts` | Реальная реализация с шифрованием |

---

## 📋 `password-service.ts` — Интерфейс сервиса

Этот файл содержит **интерфейс** `PasswordService`. Это не рабочий код, а "договор" — список обещаний о том, что должен уметь делать любой сервис паролей.

### Что такое интерфейс?

Представьте, что вы заказываете кофе в кафе. Вы говорите: "Мне нужен кофе с молоком". Вы не уточняете, как именно его готовят — это "интерфейс" (что нужно получить). Бариста может приготовить его разными способами — это "реализация" (как это делается).

### Код интерфейса:

```typescript
export interface PasswordService {
  // Получить все пароли из хранилища
  getAllPasswords(): Promise<PasswordEntry[]>;
  
  // Добавить новый пароль
  addPassword(entry: Omit<PasswordEntry, 'id' | 'createdAt'>): Promise<PasswordEntry>;
  
  // Получить один пароль по ID
  getPassword(id: string): Promise<PasswordEntry | null>;
  
  // Обновить существующий пароль
  updatePassword(id: string, updates: Partial<Omit<PasswordEntry, 'id' | 'createdAt'>>): Promise<PasswordEntry | null>;
  
  // Удалить пароль
  deletePassword(id: string): Promise<boolean>;
}
```

### Разбор каждого метода:

#### 1. `getAllPasswords()`

```typescript
getAllPasswords(): Promise<PasswordEntry[]>
```

**Что делает:** Возвращает список всех сохранённых паролей.

**Что такое `Promise`:** Это обещание, что данные будут получены (асинхронная операция).

**Что такое `PasswordEntry[]`:** Массив (список) записей о паролях.

**Пример использования:**
```typescript
const passwords = await passwordService.getAllPasswords();
// passwords = [
//   { id: "1", service: "google", username: "ivan", password: "secret", createdAt: ... },
//   { id: "2", service: "vk", username: "ivan2", password: "secret2", createdAt: ... }
// ]
```

---

#### 2. `addPassword()`

```typescript
addPassword(entry: Omit<PasswordEntry, 'id' | 'createdAt'>): Promise<PasswordEntry>
```

**Что делает:** Добавляет новый пароль в хранилище.

**Что такое `Omit<PasswordEntry, 'id' | 'createdAt'>`:** 

Это тип `PasswordEntry`, но **без** полей `id` и `createdAt`. Почему? Потому что эти поля генерируются автоматически — вам не нужно их передавать.

**Пример использования:**
```typescript
// Передаём только то, что знаем
const newPassword = await passwordService.addPassword({
  service: "facebook.com",
  username: "myemail@example.com",
  password: "MySecret123!"
  // id и createdAt добавятся автоматически!
});

// Получаем полную запись с ID и датой
console.log(newPassword.id);        // "550e8400-e29b-41d4-a716-446655440000"
console.log(newPassword.createdAt); // Date object
```

---

#### 3. `getPassword()`

```typescript
getPassword(id: string): Promise<PasswordEntry | null>
```

**Что делает:** Находит один пароль по его уникальному ID.

**Что такое `PasswordEntry | null`:** Либо найдена запись, либо `null` (если не найдена).

**Пример использования:**
```typescript
const entry = await passwordService.getPassword("550e8400-e29b-41d4-a716-446655440000");

if (entry) {
  console.log("Найден:", entry.service);
} else {
  console.log("Пароль не найден");
}
```

---

#### 4. `updatePassword()`

```typescript
updatePassword(
  id: string, 
  updates: Partial<Omit<PasswordEntry, 'id' | 'createdAt'>>
): Promise<PasswordEntry | null>
```

**Что делает:** Обновляет существующий пароль.

**Что такое `Partial<...>`:** 

`Partial` делает все поля необязательными. Вы можете обновить только то, что нужно:

```typescript
// Обновить только пароль
await passwordService.updatePassword("id-123", {
  password: "NewPassword456!"
});

// Или обновить и сервис, и логин
await passwordService.updatePassword("id-123", {
  service: "new-site.com",
  username: "new-email@example.com"
});
```

---

#### 5. `deletePassword()`

```typescript
deletePassword(id: string): Promise<boolean>
```

**Что делает:** Удаляет пароль по ID.

**Что возвращает:** `true` если удалено успешно, `false` если пароля с таким ID не было.

**Пример использования:**
```typescript
const deleted = await passwordService.deletePassword("id-123");

if (deleted) {
  console.log("Пароль удалён");
} else {
  console.log("Пароль не найден");
}
```

---

## 🔐 `encrypted-password-service.ts` — Реальная реализация

Этот файл содержит **реальный рабочий код**, который:
- Шифрует пароли перед сохранением
- Расшифровывает при чтении
- Сохраняет данные в файл
- Проверяет мастер-пароль

### Класс `EncryptedPasswordService`

```typescript
export class EncryptedPasswordService implements PasswordService {
  // ... реализация всех методов интерфейса
}
```

Ключевое слово `implements PasswordService` означает: "Этот класс обещает выполнять всё, что требует интерфейс".

### Внутренние поля класса:

```typescript
private passwords: Map<string, PasswordEntry> = new Map();
private masterKey: Buffer | null = null;
private initialized = false;
private dataFile: string;
```

| Поле | Назначение |
|------|------------|
| `passwords` | Временное хранилище паролей в памяти (как словарь) |
| `masterKey` | Ключ шифрования (генерируется из мастер-пароля) |
| `initialized` | Флаг: инициализирован ли сервис |
| `dataFile` | Путь к файлу с зашифрованными данными |

---

## 🗝️ Как работает шифрование

### Общая схема:

```
┌─────────────────────────────────────────────────────────────┐
│  Ваш мастер-пароль: "MyMasterPassword123"                   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼  Функция deriveKey (scrypt)
┌─────────────────────────────────────────────────────────────┐
│  Соль (случайные данные) + Мастер-пароль                    │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼  Хеширование
┌─────────────────────────────────────────────────────────────┐
│  Ключ шифрования (256 бит)                                  │
│  a7f3b2c9d8e1... (32 байта)                                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼  Алгоритм AES-256-GCM
┌─────────────────────────────────────────────────────────────┐
│  Пароль "MySecret123!"                                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼  Шифрование
┌─────────────────────────────────────────────────────────────┐
│  Зашифрованные данные                                       │
│  f8d2a9... (бессмысленный набор символов)                   │
└─────────────────────────────────────────────────────────────┘
```

### Ключевые понятия:

#### Соль (Salt)

**Что это:** Случайные данные, которые добавляются к паролю перед хешированием.

**Зачем:** Если два пользователя имеют одинаковый пароль, их хеши будут разными благодаря разной соли.

```typescript
const salt = randomBytes(32);  // 32 случайных байта
```

#### Ключ шифрования (Key)

**Что это:** Специальный код, полученный из мастер-пароля с помощью соли.

**Как получается:**
```typescript
private deriveKey(password: string, salt: Buffer): Buffer {
  return scryptSync(password, salt, 32);  // 32 байта = 256 бит
}
```

Функция `scryptSync` — это специальный алгоритм, который:
- Медленно превращает пароль в ключ (это хорошо для безопасности)
- Делает одинаковый пароль и соль → одинаковый ключ
- Делает разную соль → разный ключ

#### AES-256-GCM

**Что это:** Алгоритм шифрования, признанный одним из самых надёжных в мире.

- **AES** — Advanced Encryption Standard (продвинутый стандарт шифрования)
- **256** — длина ключа в битах (очень надёжно)
- **GCM** — режим работы (обеспечивает целостность данных)

**Как шифруется:**
```typescript
private encrypt(text: string): { encrypted: string; iv: string; authTag: string } {
  const iv = randomBytes(16);  // Вектор инициализации
  const cipher = createCipheriv('aes-256-gcm', this.masterKey!, iv);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  return {
    encrypted,                    // Зашифрованный текст
    iv: iv.toString('hex'),      // IV для расшифровки
    authTag: cipher.getAuthTag().toString('hex')  // Проверка целостности
  };
}
```

**Что такое IV (Initialization Vector):**

Это случайные данные, которые делают одинаковый пароль выглядеть по-разному при каждом шифровании. Даже если вы дважды зашифруете "password", результаты будут разными (но оба расшифруются правильно).

**Что такое Auth Tag:**

Это "подпись", которая позволяет проверить, что данные не были изменены.

---

## 📁 Структура файла `passwords.dat`

Вот как выглядит сохранённый файл:

```json
{
  "masterHash": "a3f7b2...:d8e1c5...",
  "passwords": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "service": "google.com",
      "username": "ivan@example.com",
      "encryptedPassword": "f8d2a9...",
      "salt": "",
      "iv": "b4c8e2...",
      "authTag": "a1b3c5...",
      "createdAt": "2024-01-15T10:30:00.000Z"
    }
  ]
}
```

| Поле | Описание |
|------|----------|
| `masterHash` | Хеш мастер-пароля для проверки при входе |
| `passwords` | Массив зашифрованных записей |
| `encryptedPassword` | Пароль в зашифрованном виде |
| `iv` | Вектор инициализации для расшифровки |
| `authTag` | Проверка целостности |

---

## 🔄 Жизненный цикл сервиса

```
┌─────────────────────────────────────────────────────────────┐
│  1. СОЗДАНИЕ                                                │
│  new EncryptedPasswordService('passwords.dat')              │
│  → Создаётся пустой сервис                                  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  2. ИНИЦИАЛИЗАЦИЯ                                           │
│  service.initialize("MyMasterPassword")                     │
│                                                             │
│  Файл не существует? → Создаётся новое хранилище            │
│  Файл существует?  → Открывает существующее                 │
│                      (проверяет мастер-пароль!)             │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  3. ИСПОЛЬЗОВАНИЕ                                           │
│  • getAllPasswords() — читает расшифрованные данные         │
│  • addPassword() — добавляет, шифрует, сохраняет            │
│  • deletePassword() — удаляет и сохраняет                   │
│                                                             │
│  После каждого изменения → автоматически save()             │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  4. ЗАВЕРШЕНИЕ                                              │
│  Данные уже сохранены в файл                                │
│  Можно просто выйти из программы                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 💡 Ключевые концепции для понимания

### Map — хранилище в памяти

```typescript
private passwords: Map<string, PasswordEntry> = new Map();
```

`Map` — это как словарь или телефонная книга:
- Ключ (string) → ID пароля
- Значение (PasswordEntry) → полная запись

**Основные операции:**
```typescript
// Добавить
this.passwords.set(id, entry);

// Получить
const entry = this.passwords.get(id);

// Удалить
this.passwords.delete(id);

// Получить все
const all = Array.from(this.passwords.values());
```

### Buffer — бинарные данные

```typescript
private masterKey: Buffer | null = null;
```

`Buffer` — это способ хранить сырые байты (двоичные данные). Нужен для работы с криптографией.

### timingSafeEqual — безопасное сравнение

```typescript
return timingSafeEqual(newHash, storedKey);
```

Обычное сравнение строк (`===`) занимает разное время в зависимости от количества совпадающих символов. Это позволяет хакерам угадать пароль по времени ответа.

`timingSafeEqual` всегда занимает одно и то же время — безопаснее!

---

**Теперь вы понимаете, как работает хранение и шифрование паролей! Переходите к изучению UI, чтобы узнать, как это всё отображается на экране.**